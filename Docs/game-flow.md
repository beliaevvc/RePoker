# Флоу игры и каскада (таймлайн)

Этот документ описывает **как игра “движется”** по состояниям и какие use‑cases участвуют.

## Главные сущности

- **Hand (рука)**: 5 карт на столе.
- **Deck (колода)**: массив карт, из которого добираем.
- **DealIndex**: индекс следующей карты в колоде.
- **Bet / Balance**: ставка и баланс игрока.
- **EvalResult**: результат оценки руки (комбо, множитель, winningIndices).

## Состояния экрана (`gameState`)

Контроллер: `src/ui/screens/balatro-inferno/useBalatroInfernoController.js`.

- **`idle`**: ожидаем действие (PLAY).
- **`dealing`**: “раздача” по 1 карте через таймеры до 5 карт.
- **`suspense`**: короткая пауза перед расчётом результата/стартом каскада.
- **`cascading`**: каскадный таймлайн (шаги + анимации vanish/refill).
- **`result`**: финальный экран (последняя оценка руки + итоговые баннеры/история).

## “Режимы” игры

Текущий UI ориентирован на **CASCADE** (normal сейчас скрыт/отключён флагом).

- **Normal**: одна оценка руки → один payout.
- **Cascade**: серия шагов. Если на шаге есть выигрыш — выигрышные карты исчезают, на их место добираются новые, и шаг повторяется.

## Use‑cases (Application слой)

Файлы: `src/application/game/usecases/*`.

- `startDealUseCase`: старт раздачи (списание ставки, выдача начальной руки/состояния).
- `resolveResultUseCase`: финальный расчёт в normal‑режиме.
- `applyCascadeStepUseCase`: “один логический шаг каскада” (оценка руки → выигрыш → подготовка `handBefore/handAfter`, `winningIndices`, `deckAfter/dealIndexAfter`, множители/джекпот).
- `adjustBetUseCase`: изменение ставки с правилами.
- `forceHandUseCase` (debug): “сфорсить” руку (джокеры) для проверки редких веток.

## Каскад: логика vs анимация

В каскаде важно различать:

- **Логическое состояние** (счёт шага/выигрыша/колоды) — хранится в `ref`, чтобы не ломать таймлайн при ререндерах.
- **UI‑анимации** (баннеры, исчезновение, появление, flash) — управляются `setState` через scheduler.

### Защита от “гонок” таймеров

- У каждого входа в каскадный `useEffect` увеличивается токен (`cascadeAnimTokenRef`).
- Все таймеры guard’ятся токеном: callback старого шага игнорируется.
- Cleanup идёт централизованно через `scheduler.clearAll()`.

## Один шаг каскада — последовательность

Внутри `gameState === 'cascading'` контроллер:

1) **Вычисляет шаг** (`applyCascadeStepUseCase`) из “логической” руки.
2) Если **нет выигрыша** → **finish**:
   - начисляет `totalWin` одним платежом,
   - фиксирует историю/итоги,
   - переводит в `result`.
3) Если **выигрыш есть** → ставит таймеры анимации:
   - **Reveal**: показать `handBefore`
   - **Banner**: показать баннер выигрыша, подсветку `winningIndices`, обновить “running win”
   - **Hide banner**
   - **Vanish**: запустить исчезновение выигрышных карт
   - **Empty slots**: заменить выигрышные карты на `null`
   - **Refill**: по одному “впрыснуть” новые карты в пустые слоты
   - **Commit**: зафиксировать `deckAfter/dealIndexAfter` и логическую руку `handAfter`
   - **Refill flash**: короткий highlight на “всё обновилось”
   - **Next / Finish(deck-shortage)**: либо следующий шаг, либо завершение при нехватке карт

### Тайминги refill (важно для UX)

Таймлайн вынесен в `src/ui/screens/balatro-inferno/cascadeTimeline.js` и покрыт тестом `cascadeTimeline.test.ts`.

Базовые константы:

- `appearStart = 1080ms`
- `appearDelay = 120ms` (между появлением каждой новой карты)
- `appearHold = 260ms` (сколько держать индикатор “appearing”)

Дальше рассчитываются “вехи”:

- `commitAt = appearStart + N*appearDelay + 40`
- `flashOnAt = appearStart + N*appearDelay + 80`
- `flashOffAt = appearStart + N*appearDelay + 260`
- `endAt = appearStart + N*appearDelay + 520`

## Turbo

Turbo ускоряет таймлайн через `timeFactor` (внутри scheduler): сейчас используется множитель **0.5** (в 2 раза быстрее) для каскада и короткие таймеры при раздаче.

## AutoPlay

AutoPlay — это отдельный оркестратор эффектом:

- Стартует новый спин только когда экран “готов” (`idle` или `result`)
- Уменьшает счётчик после завершения предыдущего спина
- Останавливается по причинам (нет денег / busy / cannot-start / done)

## Debug / Simulation

Есть режим симуляции джекпота (для быстрых проверок каскада):

- `buildJackpotSimulationScenario` подготавливает сценарий колоды/руки.
- Контроллер “пропускает” dealing, ставит `suspense`, и дальше идёт в каскад.


