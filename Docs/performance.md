# Перфоманс: что сделали и как не регресснуть

## TL;DR (принципы)

- Изолируем ререндеры: **мемоизация**, **стабильные пропсы**, **не рендерить тяжёлое когда не нужно**.
- Тяжёлые DOM‑измерения — **коалесцируем** (например, через `requestAnimationFrame`).
- Таймлайны каскада — **детерминируем** и защищаем токеном, чтобы не было “гонок”.
- В production‑замерах используем **`npm run build && npm run preview`**.

## Что оптимизировали (факты по коду)

### 1) UI: уменьшили “ширину” рендера

- Экран разбит на memo‑поддеревья (внутри `src/ui/screens/balatro-inferno/BalatroInferno.jsx`).
- Inline‑callbacks заменены на `useCallback`, чтобы memo реально работал.

### 2) DevToolsDrawer: не тянем тяжёлое в игровой таймлайн

- Когда drawer закрыт — тяжёлый контент (логи/списки) не рендерится.
- “Собрать текст лога для копирования” делается по действию пользователя (а не на каждый render).

### 3) Layout/Style: коалесцирование измерений

- Overflow‑проверка для CHIPS коалесцируется через `requestAnimationFrame` (не чаще 1 раза за кадр).

### 4) Сеть/загрузка: локальные текстуры

- Внешние текстуры заменены на локальные SVG в `public/textures/*`.
- Это уменьшает зависимость от сторонних доменов и ускоряет/стабилизирует первый рендер (особенно на мобилках).

### 5) Шрифт: ранняя загрузка через `index.html`

- Шрифт перенесён из `@import` в CSS на `<link rel="stylesheet">` в `index.html` + `preconnect`.

### 6) Контроллер/таймлайн каскада: scheduler + тестируемый refill‑таймлайн

- Таймеры каскада идут через `createScheduler` (token‑guard + `clearAll`).
- Refill‑тайминг вынесен в `scheduleCardRefillTimeline` и покрыт тестом на `fakeClock`.

## Как не регресснуть (практика)

### React

- Любая новая “большая” панель/оверлей:
  - рендерить содержимое **только когда открыт**
  - отделять от каскадных обновлений (props должны быть “тонкие”)
- При memo‑компонентах:
  - не передавать inline‑объекты/массивы/функции без `useMemo/useCallback`

### CSS / эффекты

- `blur/filter/mix-blend-mode` и большие overlays могут “убивать” GPU на iPhone.
- Любая тяжёлая визуальная фича должна иметь:
  - понятную область действия
  - возможность быстро отключить/откатить (если просадка)

### DOM измерения

- Нельзя мерить layout на каждый мелкий апдейт state — это почти гарантированный `Recalculate Style/Layout`.
- Измерения делать:
  - редко (rAF)
  - в нужном месте (локальный компонент)


