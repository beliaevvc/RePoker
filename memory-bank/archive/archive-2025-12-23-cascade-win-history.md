# Archive: Cascade Win History

**Date**: 2025-12-23
**Status**: Completed
**Task**: Добавить возможность просмотра истории выигрышных комбинаций (рук) внутри одного каскада.

## 1. Summary
В режим каскада добавлена функциональность истории. Теперь игрок может увидеть детальный список всех выигрышных шагов (комбинация, сумма, множитель, карты) после завершения каскада. Это повышает прозрачность и удовлетворение от "серии побед".

## 2. Requirements (UX)
- **Триггер**: Кнопка `WINS (N)` рядом с суммой выигрыша в индикаторе каскада.
- **Доступность**: Кнопка активна только в состояниях `idle` (до старта) и `result` (после финала). Во время анимации каскада кнопка заблокирована.
- **Индикация**: Активная кнопка пульсирует (`animate-pulse-slow-glow`).
- **Просмотр**: Модальное окно (стиль Pixel/CRT) со скроллируемым списком.
- **Карточки**: Каждый шаг показывает номер, название руки, выигрыш, множитель и 5 мини-карт.

## 3. Implementation
- **Controller**:
  - `useBalatroInfernoController`: добавлен стейт `cascadeWinHistory` (накопительный) и `lastCascadeWinHistory` (фиксированный для result).
  - Использован `useRef` для доступа к актуальной истории внутри таймеров `useEffect` (во избежание ре-рендеров и сброса анимации).
- **Components**:
  - `CascadeHistoryModal.jsx`: оверлей со списком.
  - `MiniCard.jsx`: легковесный компонент карты (32x44px).
  - `CascadeMultiplierIndicator.jsx`: обновлен для поддержки триггера и пропса `historyEnabled`.

## 4. Testing
- **Unit**: Тесты use-cases (логика каскада) не менялись, так как история — это UI-layer фича.
- **Manual/QA**:
  - Проверен сценарий с 1 выигрышем.
  - Проверен сценарий с 10+ выигрышами (скролл работает).
  - Проверен Jackpot (отображается бейдж).
  - Проверена блокировка кнопки во время анимации.
  - Проверена корректность данных (суммы, множители совпадают с логом).

## 5. Lessons Learned
- При реализации сложных таймлайнов на `setTimeout` внутри `useEffect` нельзя добавлять изменяемый стейт (как `history` массив) в зависимости эффекта — это приводит к сбросу анимации. Решение: использовать `useRef` для чтения актуальных данных внутри колбэков.

## 6. References
- Creative: `memory-bank/creative/creative-cascade-win-history.md`
- Reflection: `memory-bank/reflection/reflection-2025-12-23-cascade-history.md`

