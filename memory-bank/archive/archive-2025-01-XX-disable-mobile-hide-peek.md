# Архив: Отключение FPN-эффекта hide-peek на мобильных устройствах

**Дата:** 2025-01-XX  
**Сложность:** Level 1 (быстрый фикс)  
**Статус:** ✅ Завершено

---

## Summary

Отключён FPN-эффект с апом на карты в конце раздачи (когда три тапа и карта прячется) на мобильных устройствах. На десктопе эффект остался без изменений. Задача выполнена путём добавления проверки на мобильное устройство и условного отключения анимации hide-peek в компоненте `Card.jsx`.

**Результат:** На мобильных устройствах при трёх тапах на карту эффект hide-peek не запускается (счётчик просто сбрасывается). На десктопе поведение осталось прежним — эффект работает как раньше.

---

## Requirements

### Цель
Отключить FPN-эффект с апом на карты в конце раздачи (когда три тапа и карта прячется) на мобильном устройстве. На десктопе оставить без изменений.

### Ограничения
- Изменения только в компоненте `Card.jsx`
- Не трогать другие анимации карт (shake-weak, shake-strong, idle и т.д.)
- Десктоп должен работать как раньше

### Риски
Низкие — локальное изменение в одном компоненте, минимальное влияние на остальную логику.

---

## Implementation

### Изменённые файлы
- `src/ui/screens/balatro-inferno/components/Card.jsx`

### Выполненные изменения

#### 1. Добавлена проверка на мобильное устройство (строки 205-206)
```jsx
// Проверка на мобильное устройство (touch-устройство)
const isMobileDevice = typeof window !== 'undefined' && window.matchMedia?.('(pointer: coarse)').matches
```

**Обоснование:**
- Использован `window.matchMedia('(pointer: coarse)')` для определения touch-устройств
- Этот же способ уже используется в проекте (например, в `BalatroInferno.jsx` для landscape guard)
- Проверка `typeof window !== 'undefined'` добавлена для безопасности при SSR

#### 2. Отключена логика hide-peek на мобильных (строки 264-270)
```jsx
} else if (nextCount >= 3) {
  // На мобильных устройствах отключаем эффект hide-peek
  if (isMobileDevice) {
    // На мобильных просто сбрасываем счётчик без запуска анимации
    setClickCount(0)
    setAnimState('idle')
    return
  }

  // На десктопе работаем как раньше
  // ... (остальная логика без изменений)
}
```

**Обоснование:**
- Ранний return на мобильных — простое и понятное решение
- Минимальное изменение, не затрагивающее остальную логику
- Десктопный код остался без изменений, что гарантирует отсутствие регрессий

### Методология
- Использован существующий в проекте способ определения мобильных устройств (`(pointer: coarse)`)
- Добавлена условная проверка перед запуском анимации
- Сохранена вся остальная логика без изменений

---

## Testing

### Автоматические проверки
- ✅ **Линтер:** ошибок не обнаружено
- ✅ **Сборка:** `npm run build` завершена успешно (991ms)
  ```
  ✓ 1730 modules transformed.
  dist/index.html                   0.84 kB │ gzip:  0.45 kB
  dist/assets/index-KvTLYJ1s.css   84.14 kB │ gzip: 14.30 kB
  dist/assets/index-C21ofqv9.js   280.76 kB │ gzip: 86.06 kB
  ✓ built in 991ms
  ```

### Ручная проверка
- ⚠️ **Проверка на мобильном устройстве:** требует ручного тестирования пользователем для подтверждения, что эффект hide-peek не срабатывает при трёх тапах
- ⚠️ **Проверка на десктопе:** требует ручного тестирования пользователем для подтверждения, что эффект работает как раньше

### Проверка целостности
- ✅ Изменения применены только в нужном месте (функция `handleInteract`)
- ✅ Другие анимации (shake-weak, shake-strong, idle) не затронуты
- ✅ Десктопный код остался без изменений

---

## Lessons Learned

### Что сработало хорошо
1. **Использование существующего подхода** — применение `(pointer: coarse)` обеспечило консистентность с остальной кодовой базой
2. **Ранний return** — простое и понятное решение, минимальное изменение кода
3. **Сохранение десктопного поведения** — код для десктопа остался без изменений, что гарантирует отсутствие регрессий

### Сложности
Сложностей не было — задача оказалась простой благодаря:
- Чёткому пониманию требований (отключить эффект только на мобильных)
- Точному указанию места в коде (компонент `Card.jsx`, функция `handleInteract`)
- Простому решению (добавить проверку устройства и ранний return)
- Отсутствию зависимостей и побочных эффектов

### Что можно улучшить
1. **Ручная проверка на устройствах** — стоило бы явно отметить в чеклисте, что проверка требует ручного тестирования пользователем
2. **Динамическое отслеживание изменений** — можно было бы использовать `useState` + `useEffect` для отслеживания изменений `matchMedia`, но для Level 1 задачи это избыточно

### Выводы
- **Простота задачи оправдала ожидания** — Level 1 оценка была корректной
- **Чёткие требования** — точное указание эффекта и ограничений позволило выполнить задачу без вопросов
- **Минимальный риск** — изменение затрагивает только одну функцию в одном компоненте
- **Консистентность с проектом** — использование того же способа определения мобильных устройств обеспечивает единообразие

---

## Metrics

- **Время выполнения:** ~10 минут
- **Изменённых файлов:** 1
- **Добавленных строк:** 1 строка проверки устройства + 6 строк логики отключения эффекта
- **Ошибок:** 0
- **Сборка:** успешна (991ms)
- **Линтер:** ошибок нет

---

## References

- **Рефлексия:** `memory-bank/reflection/reflection-2025-01-XX-disable-mobile-hide-peek.md`
- **Задача:** Отключить FPN-эффект с апом на карты в конце раздачи (когда три тапа и карта прячется) на мобильном устройстве
- **Файл изменений:** `src/ui/screens/balatro-inferno/components/Card.jsx`
- **Связанные файлы:**
  - `src/balatroInferno.css` (строки 775-804) — определения анимаций hide-peek

---

## Rollback

При необходимости восстановления эффекта на мобильных можно убрать проверку `isMobileDevice` из условия:

```jsx
// Убрать блок:
if (isMobileDevice) {
  setClickCount(0)
  setAnimState('idle')
  return
}
```

Или использовать git для отката:
```bash
git log --oneline --all -- src/ui/screens/balatro-inferno/components/Card.jsx
git show <commit-hash>:src/ui/screens/balatro-inferno/components/Card.jsx
```

