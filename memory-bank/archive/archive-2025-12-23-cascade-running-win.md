# Archive — 2025-12-23 — CASCADE running WIN under multiplier

## Summary
Добавлен накопительный индикатор **`WIN {total}`** под блоком `CASCADE MULT` во время каскада: появляется **после первого выигрыша**, на каждом win‑шаге **анимировано увеличивается**, остаётся видимым **до/на экране финального результата** вместе с баннером `TOTAL WIN`, и **сбрасывается перед новой сдачей**.

## Requirements
- Показывать **накопительный total** под `CASCADE MULT` во время каскадов.
- Сумма должна **анимировано изменяться** при каждом выигрышном шаге (добавление выигрыша шага).
- Показывать **только после первого выигрыша**.
- Формат: **`WIN 123.45`**.
- По фидбэку:
  - `WIN` расположен **под мультипликаторами** (под “пилюлями” 1×/2×/3×/5×).
  - `WIN` **остаётся видимым**, когда появляется финальный баннер `TOTAL WIN`.
  - `WIN` **исчезает перед началом** следующей сдачи.
  - При появлении `WIN` **не сдвигает контент** (без “прыжков” layout).
  - `WIN` сделать **чуть крупнее** и **опустить ниже** (больше воздуха).

## Implementation
- **Синхронизация таймингов totalWin**:
  - Перенесён логический инкремент `cascadeTotalWinRef.current` на фазу вычисления win‑шага, чтобы `cascadeRunningTotalWin` можно было показать уже в момент reveal win‑баннера (синхронное “прибавление” в UI).
  - Убрано позднее повторное инкрементирование (предотвращение двойного начисления).
- **Показ/поведение WIN**:
  - В `cascading`: `WIN` отображается только когда `cascadeRunningTotalWin > 0`.
  - В `result`: `WIN` остаётся видимым и берёт значение `lastCascadeTotalWin` (вместе с `TOTAL WIN`).
  - Перед новой сдачей: `resetCascade()` сбрасывает `cascadeRunningTotalWin` в 0.
- **UI/анимация**:
  - `CascadeMultiplierIndicator` получил `runningWin/showRunningWin/timeFactor`.
  - Число анимируется count‑up через `requestAnimationFrame` + CSS pop/glow (`animate-cascade-win-pop`, `cascade-win-glow`).
  - Учтён `prefers-reduced-motion` (без анимации).
  - Для отсутствия “прыжков” layout место под `WIN` зарезервировано всегда (фикс. высота + `opacity-0` когда скрыто).
  - Подстройки по “воздуху”: увеличены высота блока и отступы, увеличен кегль `WIN`.

## Testing
- `npm run lint` — ✅
- `npm test` — ✅ (24/24)
- `npm run build` — ✅
> Примечание: команды прогонялись вне sandbox из-за `EPERM` при доступе к `node_modules` в sandbox.

## Lessons learned
- Для “правильного game feel” важен **момент обновления** накопительных значений: если обновлять total только после длинной анимации, UI воспринимается как “запаздывающий”.
- Для частых UI‑индикаторов лучше резервировать пространство и менять `opacity`, чем добавлять/убирать DOM‑узел, чтобы избежать layout‑сдвигов.

## References
- Reflection: `memory-bank/reflection/reflection-2025-12-23-cascade-running-win.md`

