# Archive — 2025-01: Актуализация Product Context

## Summary

Задача: актуализировать `memory-bank/productContext.md` с учётом текущего состояния проекта (Clean Architecture, режимы CASCADE/NORMAL, автоплей, каскадные множители, актуальные пути к файлам).

Итог: документ полностью переписан и расширен с 23 до 142 строк. Обновлены все пути к файлам, добавлены описания новых фич (CASCADE, автоплей, TURBO, каскадные множители), добавлены предупреждения о статусе отключённых фич (NORMAL режим). Документация теперь отражает актуальное состояние проекта и структурирована по разделам.

## Requirements

- Актуализировать `productContext.md` с учётом текущего состояния проекта.
- Исправить устаревшие пути к файлам (например, `getBestHand` был указан в `src/BalatroInferno.jsx`, но фактически находится в `src/domain/hand-evaluator/getBestHand.ts`).
- Добавить описания новых фич:
  - Режим CASCADE (каскадные шаги, удаление выигрышных карт, добор новых).
  - Режим NORMAL (с пометкой о том, что отключен).
  - Автоплей (AUTO): выбор количества спинов, автоматическое выполнение.
  - TURBO режим: ускорение анимаций в 2 раза.
  - Каскадные множители (1× → 2× → 3× → 5× для win-steps).
- Обновить информацию о загрузке шрифтов (через `<link>` в `index.html`, не через `@import`).
- Добавить информацию об анимациях каскада и CRT-оверлее.
- Уточнить описание игровых механик (Bet, Streak, Balance).

## Implementation

### Структурные изменения

Документ переструктурирован по разделам:
- **Пользовательский сценарий** (базовый сценарий + режимы CASCADE/NORMAL + автоплей + TURBO).
- **Основные игровые сущности** (Deck/Hand, Balance, Bet, Streak, каскадные множители).
- **Комбинации и множители** (с актуальными путями к файлам).
- **Режимы игры** (NORMAL vs CASCADE с пометками о статусе).
- **Автоплей** (детальное описание механизма).
- **TURBO режим** (описание влияния на таймлайн).
- **UX/визуальный стиль** (пиксельный стиль, CRT-оверлей, анимации, шрифты).

### Исправленные пути к файлам

- `getBestHand`: `src/domain/hand-evaluator/getBestHand.ts` (было: `src/BalatroInferno.jsx`).
- Таблицы констант: `src/domain/hand-evaluator/constants.ts`.
- Use-cases: актуальные пути в `src/application/game/usecases/`.
- Каскадные множители: `src/application/game/cascadeMultiplier.ts`.
- Список ставок: `src/application/game/constants/ante.ts`.

### Добавленные разделы

1. **Режим CASCADE**:
   - Описание каскадных шагов.
   - Механика удаления выигрышных карт и добора новых.
   - Правила начисления выигрыша (одним платежом в конце).
   - Информация о том, что Streak не используется в CASCADE.

2. **Режим NORMAL**:
   - Описание классического режима (одна оценка руки, один payout).
   - ⚠️ Пометка о том, что режим отключен (`NORMAL_MODE_ENABLED = false`) и возможно будет удалён.

3. **Автоплей**:
   - Описание модалки выбора количества спинов (10/25/50/100/∞).
   - Механизм автоматического выполнения спинов.
   - Условия запуска и остановки.
   - Визуальная индикация (счётчик на кнопке PLAY).

4. **TURBO режим**:
   - Описание переключателя ускорения анимаций (множитель времени `0.5`).
   - Влияние на раздачу карт и каскадные анимации.
   - Визуальная индикация (подсветка кнопки).

5. **Каскадные множители**:
   - Правила применения (1× → 2× → 3× → 5× для win-steps).
   - Применение только к выплате за комбинацию (не к jackpot).
   - Путь к реализации: `src/application/game/cascadeMultiplier.ts`.

### Уточнённые описания

- **Bet**: минимальная ставка 0.2, максимальная 100 (из списка `ANTE_VALUES`), добавлен полный список доступных значений.
- **Streak**: уточнено, что в CASCADE не используется (отключён), в NORMAL работает (но режим отключен).
- **Загрузка шрифтов**: исправлена информация (через `<link>` в `index.html` с `preconnect`, не через `@import` в CSS).
- **Анимации каскада**: добавлены описания `cascade-vanish`, `cascade-appear`, `cascade-refill-flash`.

### Итеративные правки после ревью

- Добавлены предупреждения (⚠️) о том, что режим NORMAL отключен и возможно будет удалён.
- Уточнено описание Streak: в CASCADE не используется, в NORMAL работает (но режим отключен).
- Исправлено описание максимальной ставки: максимум 100 из списка `ANTE_VALUES` (не "максимум баланса").

## Testing

- Проверка актуальности путей к файлам через `glob_file_search`:
  - ✅ `src/domain/hand-evaluator/getBestHand.ts` — существует.
  - ✅ `src/domain/hand-evaluator/constants.ts` — существует.
  - ✅ `src/application/game/usecases/startDeal.ts` — существует.
  - ✅ `src/application/game/usecases/adjustBet.ts` — существует.
  - ✅ `src/application/game/cascadeMultiplier.ts` — существует.
  - ✅ `src/application/game/constants/ante.ts` — существует.
- Проверка соответствия описаний реальному коду через `codebase_search` и `grep`:
  - ✅ Проверены флаги (`NORMAL_MODE_ENABLED = false`).
  - ✅ Проверены константы (`ANTE_VALUES`).
  - ✅ Проверено поведение Streak в CASCADE (отключён).
- Линтер: без ошибок.

## Lessons learned

### Удачные решения

1. **Структурирование документа по разделам**: улучшило читаемость и навигацию.
2. **Использование предупреждений (⚠️)**: помогло явно обозначить статус отключённых фич.
3. **Детальное описание новых фич**: включает технические детали (пути к файлам, механизмы работы).
4. **Проверка актуальности путей**: использование `glob_file_search` гарантирует, что все пути актуальны.

### Что улучшить в процессе

1. **Проверка флагов и констант**: при обновлении документации всегда проверять флаги (например, `NORMAL_MODE_ENABLED`) и константы (например, `ANTE_VALUES`) в коде.
2. **Изучение архивов перед обновлением**: читать архивные документы для понимания истории изменений и актуального состояния фич.
3. **Итеративный подход к документации**: после первого обновления запрашивать ревью у пользователя и учитывать замечания.

### Неудачные решения (исправленные)

1. **Первоначальное описание максимальной ставки**: изначально написано "максимум текущего balance", но фактически максимум 100 из списка `ANTE_VALUES`. Исправлено после ревью.
2. **Недостаточная детализация о статусе NORMAL режима**: первоначально не было явных пометок о том, что режим отключен. Исправлено после ревью.
3. **Отсутствие информации о Streak в CASCADE**: первоначально было написано, что streak работает в CASCADE, но фактически он отключён. Исправлено после ревью.

## References

- **Reflection**: `memory-bank/reflection/reflection-2025-01-product-context.md`
- **Updated file**: `memory-bank/productContext.md` (расширен с 23 до 142 строк)
- **Related archives**:
  - `memory-bank/archive/archive-2025-12-20-cascade-mode.md` — информация о внедрении режима CASCADE
  - `memory-bank/archive/archive-2025-12-21-cascade-multiplier.md` — информация о каскадных множителях
  - `memory-bank/archive/archive-2025-12-21-autoplay.md` — информация об автоплее
  - `memory-bank/archive/archive-2025-12-21-turbo-button.md` — информация о TURBO режиме

