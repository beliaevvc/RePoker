# Рефлексия — Dev Mode / Dev Tools v1 (2025-12-21)

## Контекст / задача
Сделать отдельный **Dev Mode**, вызываемый кнопкой рядом с переключателем **NORMAL/CASCADE** (до **TURBO**), который открывает панель инструментов:
- toggle debug-оверлея (раньше по `D`)
- перенос `JP` (jackpot simulation) внутрь Dev Tools
- лог действий (с Clear/Copy/Pause)
- просмотр состояния/колоды (deck remaining и пр.)

## План vs факт

### Что планировали
- Кнопка `DEV` в верхней панели рядом с `NORMAL/CASCADE` и до `TURBO`.
- Drawer слева на desktop + sheet на mobile, остаётся видимым во время каскада.
- Gating: dev-only по умолчанию + возможность скрытого включения в prod через query/localStorage.
- Перенос `JP` из основного UI в Dev Tools, `1J/2J` убрать.
- Action log + deck/state watch.

### Что сделали (фактически)
- **UI**
  - Добавлена кнопка **DEV** в верхней панели.
  - Реализован компонент `DevToolsDrawer`:
    - desktop: **drawer слева**
    - mobile: **bottom-sheet**
  - Панель не блокирует игру и может оставаться открытой во время каскада.
- **Gating**
  - Dev Tools разрешены в dev (`import.meta.env.DEV`).
  - В prod можно включить через `?dev=1`/`?devtools=1` или `localStorage('repoker.devTools'='1')`.
  - Дополнительно: кнопку DEV сделали **видимой на desktop всегда**, даже если tools “выключены”; внутри drawer появляется экран “Dev tools выключены” с кнопкой **Enable (reload)**.
- **Функции Dev Tools**
  - Toggle debug-оверлея (кнопкой и по `D`, но `D` работает только когда tools разрешены).
  - `JP SIM` перенесён в Dev Tools, основная кнопка `JP` убрана из главного UI.
  - `1J/2J` убраны из UI.
  - Action log (cap 400) с **Пауза/Очистить/Копия**, тексты на русском.
  - В лог добавлена подпись выигрышной комбинации (например `Pair 33`, `Full House 999J*J*`).
  - State/deck watch с русскими названиями полей.
- **Качество**
  - `npm run lint` ✅, `npm run test` ✅, `npm run build` ✅.

## Что было сложным / почему
- **Видимость кнопки DEV**: изначально она зависела от `devToolsAllowed`, что приводило к ситуации “кнопки нет” в prod/preview. Решение: показывать кнопку на desktop всегда и давать внутри drawer понятный способ включить tools.
- **Lint правило `react-hooks/set-state-in-effect`**: логирование `CASCADE_STEP` делало setState внутри effect. Решение: перенос логирования в `schedule(..., 0)` (асинхронно).
- **UX итерации**: потребовалось быстро адаптировать UI под реальные потребности (без затемнения, закрытие только по CLOSE, читабельный русский лог).

## Удачные решения
- Drawer слева + отсутствие backdrop — хорошо подходит для наблюдения каскада в реальном времени.
- Лог в “человеческом” виде + Copy как plain-text — быстрый обмен контекстом.
- “Enable (reload)” прямо внутри панели — снижает трение при запуске в prod/preview.

## Что можно улучшить дальше (опционально)
- **Локализация названий комбинаций** (Pair → Пара, Full House → Фулл-хаус и т.д.).
- **Более точная подпись для стритов/флешей** (в т.ч. обработка A2345, отображение мастей при желании).
- Сохранение `devToolsOpen`/позиции скролла лога между перезагрузками (localStorage).
- Фильтры/поиск по логу + “копировать последние N”.

## Итог
Первая версия Dev Tools готова и пригодна для отладки/QA: кнопка доступна, панель не мешает игре, JP перенесён, лог и состояние читаемы.


