# Reflection — 2025-12-23 — CHIPS: compact/overflow + артефакт полос при обновлении баланса

## Контекст задачи
В UI плашки **CHIPS** должно включаться сокращение (compact), когда число **не помещается**. После включения сокращений появился визуальный **артефакт**: тонкие белые полосы/штрихи рядом с цифрами при обновлении баланса (особенно в compact-формате). Артефакт исчезал после “сильного” repaint (переключение вкладки/клик SPIN).

## План vs факт
- **Планировали**: найти место рендера CHIPS, поправить условия включения compact, прогнать тесты/сборку.
- **Сделали**:
  - Исправили пограничный кейс эвристики длины строки.
  - Добавили более надёжный механизм выбора compact при реальном overflow.
  - Отдельно устранили артефакт рендера, который проявлялся только при обновлении текста.

## Что сделали (по делу)
- В `src/ui/screens/balatro-inferno/moneyFormat.js`:
  - В `formatMoneyAdaptive` изменили условие длины: `full.length >= maxFullLength` (раньше `>`), чтобы пограничные значения тоже уходили в compact.
- В `src/ui/screens/balatro-inferno/BalatroInferno.jsx`:
  - Добавили **реальный overflow-check**: измеряем ширину full-строки через `canvas.measureText` + `ResizeObserver`, и при нехватке места **форсим compact**.
  - Для стабилизации рендера текста при обновлениях добавили `transform-gpu` + `will-change-transform` на значения **CHIPS/ANTE** — это убрало “полосы” при смене баланса в compact-формате.

## Что было сложным / почему
- Проблема была **двухслойной**: логика выбора compact (overflow) и отдельная графическая проблема (GPU/композитинг текста) при частых обновлениях.
- Артефакт воспроизводился не всегда и исчезал после побочных repaint-событий, что усложняло диагностику.

## Что сработало хорошо
- Переход к измерению ширины через `canvas.measureText` (без скрытых DOM-ноды) — меньше неожиданных побочных эффектов.
- `transform-gpu` + `will-change-transform` дали практичный фикс для “грязной” перерисовки текста без изменения дизайна.

## Что улучшить в процессе
- При появлении “графических” багов сразу фиксировать признаки: зависит ли от обновления текста, исчезает ли после repaint, связан ли с transform/overlay.
- Держать “фоллбэк” стратегию (только эвристика по длине/порогу), если `ResizeObserver`/canvas недоступны.

## Проверки
- `npm test` — ✅
- `npm run build` — ✅


