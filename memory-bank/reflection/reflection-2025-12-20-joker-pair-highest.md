# Рефлексия — 2025-12-20 — Joker Pair Highest

## Контекст
Исправляли баг в `getBestHand`: при наличии джокера и формировании **одной пары** джокер выбирал пару с **самой младшей** доступной картой, а должен был выбирать с **самой старшей**.

## План vs факт
### План (из `memory-bank/tasks.md`)
- Локализовать место в `src/domain/hand-evaluator/getBestHand.ts`, где при наличии джокера выбирается ранг пары.
- Изменить правило выбора на “максимальный ранг пары”.
- Обновить/добавить unit‑тест(ы).
- Прогнать гейты: test/lint/build.

### Реализация (факт)
- **Причина бага**: при 1–2 джокерах лучшая подстановка выбиралась только по `score`. Для `Pair` `score` был одинаковым → побеждала **первая** подстановка. А перебор рангов идёт по возрастанию (`RANKS`), поэтому выбиралась младшая пара.
- **Исправление**: добавлен тай‑брейк внутри категории — теперь `score` кодирует не только “категорию”, но и “силу внутри категории” (через `SCORE_BUCKET` + `encodeRanksDesc`). Это делает выбор детерминированным и корректным при брутфорсе джокера.
- **Тест**: добавлен unit‑тест “1 джокер + разные ранги ⇒ Pair с самой старшей картой”.
- **Гейты**: `npm run test`, `npm run lint`, `npm run build` — пройдены.

## Что было самым сложным / почему
- Неприятный класс багов: логика “перебор + максимум по score” ломается, если `score` не различает варианты внутри одной категории.
- Ошибка проявлялась только при джокерах, потому что без джокеров конкретный `Pair` определяется однозначно.

## Что сработало хорошо
- Добавление теста, который фиксирует именно ожидаемое поведение выбора (старшая пара), быстро поймало и подтвердило исправление.
- Решение через “составной score” хорошо ложится на текущую архитектуру: минимальные изменения без перелопачивания API.

## Что можно улучшить дальше
- **UI/анимации**: на будущее может пригодиться явное хранение “какую карту представляет джокер” в лучшем результате (сейчас победитель определяется косвенно через подстановку).
- **Тай‑брейки**: постепенно уточнять/документировать правила тай‑брейка для всех категорий (сейчас сделано достаточно, чтобы не было “первого попавшегося” из перебора).


