# Reflection — 2025-12-23 — CASCADE running WIN under multiplier

## Контекст задачи
Нужно было во время активных каскадов показывать под `CASCADE MULT` текущий выигрыш: **накопительный total**, который **анимировано увеличивается** на каждом выигрышном шаге, и **держится** до финального баннера каскада. Доп. правки по фидбэку: расположение **под мультипликаторами**, видимость на `result` вместе с финальным баннером, скрытие **перед новой сдачей**, и отсутствие “прыжков” layout при появлении.

## План vs факт
- **План**: добавить `WIN {amount}` под `CASCADE MULT`, появление после первого win, инкрементная анимация, корректная привязка к каскадному таймлайну, CSS в фирменном стиле.
- **Факт**: сделано всё по плану + учтены дополнительные UX-правки (позиция/видимость/анти-дергание layout).

## Что реализовано
- **Накопительный WIN**:
  - Показывается **только после первого win**.
  - В `cascading` обновляется на каждом выигрышном шаге и **анимировано “добавляется”** до нового total.
  - В `result` остаётся видимым и показывает `lastCascadeTotalWin` одновременно с `TOTAL WIN`.
  - Сбрасывается перед новой сдачей (при старте нового deal).
- **Тайминг обновления**:
  - `cascadeRunningTotalWin` обновляется **в момент reveal win-баннера шага**, чтобы игрок видел прибавку синхронно с шагом каскада.
- **Анимация/стиль**:
  - JS count-up (requestAnimationFrame) + CSS pop/glow (`animate-cascade-win-pop`, `cascade-win-glow`), с учётом `prefers-reduced-motion`.
  - Поддержка Turbo через передачу `timeFactor`.
- **Layout/UX**:
  - `WIN` расположен **под мультипликаторами**.
  - Место под `WIN` **зарезервировано всегда** (через фиксированную высоту и `opacity-0`), поэтому при появлении ничего не “подпрыгивает”.
  - По фидбэку добавлен “воздух” (увеличены отступ/высота блока).

## Затруднения / почему
- **Синхронизация с каскадным таймлайном**: изначально total коммитился после refill-анимаций. Для нужного “чувства прибавления” пришлось перенести логический инкремент total на раннюю фазу (до анимаций добора), но без двойного начисления.
- **UI без прыжков**: появляющийся элемент под текстом часто двигает контент. Решено резервированием строки под `WIN`.

## Что получилось удачно
- Разделение ответственности:
  - контроллер отдаёт “истину” (total),
  - UI отвечает за визуальную анимацию (count-up + pop).
- Показ `WIN` в `result` без влияния на механику каскада (используем `lastCascadeTotalWin`).

## Что улучшить дальше (если потребуется)
- Сделать формат `WIN` консистентным с `formatMoneyFull` (если захотим валютный символ/разделители как в остальных местах).
- Добавить микровибрацию/CRT-скан в CSS для ещё большего “game feel” (если не будет перегружать).

## Проверки
- Гейты пройдены: `npm run lint`, `npm test` (24/24), `npm run build` (вне sandbox из-за `EPERM` при доступе к `node_modules` в sandbox).


