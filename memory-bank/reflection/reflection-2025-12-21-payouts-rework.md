# Reflection — 2025-12-21 — Payouts rework (новая таблица выплат)

## Контекст задачи
Нужно было переделать выплаты за покерные комбинации (как множитель “x на ставку”), добавить дробную выплату для Pair (0.3×), и убрать отдельные “джокер-комбо” (`3/4/5 Jokers`, `Five of a Kind`).

## План vs фактическая реализация
- План: обновить paytable, удалить комбо, обновить тесты и места использования, прогнать гейты.
- Факт:
  - Обновили `HAND_MULTIPLIERS` на новую таблицу и убрали неактуальные комбинации из констант.
  - Убрали ветки в `getBestHand`, которые возвращали удалённые комбинации; добавили guard на `jokerCount > 2`.
  - Почистили debug/QA инструмент `forceHand` и кнопки в UI, чтобы больше не генерить 3–5 джокеров.
  - Обновили unit‑тесты domain и application под новые multipliers (Pair=0.3).
  - Добавили “чистку денег” в application use-cases, чтобы избежать float-артефактов при дробных выплатах.
  - Гейты прошли: test/lint/build.

## Что сделали (по сути)
- Новые выплаты:
  - Pair 0.3x, Two Pair 1x, Three 5x, Straight 10x, Flush 20x, Full House 50x, Four 100x, Straight Flush 200x, Royal Flush 1000x.
- Удалили “джокер-комбо” из доменной модели и UI-упоминаний (tier темы/эффекты).
- Оставили поддержку 1–2 джокеров как wildcard (это соответствует текущей колоде 54 = 52 + 2 Jokers).

## Что было сложным и почему
- Дробные выплаты в JS:
  - Риск появления “грязных” чисел при накоплении (`0.30000000000000004` и т.п.), особенно в каскаде, где сумма копится по шагам.
  - Решение: нормализовать денежные значения на уровне application use-cases (простая стабилизация до 1e-10), сохранив при этом “точные” дроби без бизнес-округления.

## Удачные решения
- Централизация выплат в `HAND_MULTIPLIERS`: изменение сделалось точечно и автоматически протянулось везде, где считается `bet * multiplier`.
- Явное удаление комбинаций и обновление тестов: убрали старую “игровую математику” и закрепили новую спецификацию.
- Защита от `jokerCount > 2`: отлавливает некорректные debug-сценарии на ранней стадии и не даёт тихих неправильных начислений.

## Что можно улучшить дальше
- Форматирование денег в UI:
  - Сейчас UI использует прямую интерполяцию (`${balance}`, `+${win}`); при желании можно добавить единый форматтер, чтобы красиво показывать дроби (например, без лишних хвостов и с фиксированным количеством знаков, если понадобится).
- Документация правил:
  - Добавить короткий комментарий/README-секцию про актуальную таблицу выплат и про то, что в колоде максимум 2 джокера (поэтому “3+ jokers hands” не поддерживаются).

## Проверки
- `npm run test` — ok
- `npm run lint` — ok
- `npm run build` — ok


