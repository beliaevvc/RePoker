# System Patterns — RePoker

## Высокоуровневая архитектура
- **Single-screen app**: `App` рендерит один основной экран игры.
- **Clean Architecture (слои)**:
  - `src/domain/**` — доменные сущности/правила (чистые функции).
  - `src/application/**` — use-cases (сценарии) и модель состояния игры.
  - `src/infrastructure/**` — адаптеры к окружению (RNG/Clock).
  - `src/ui/**` — React UI (экран/компоненты/контроллер).

## Процесс (обязательные “мета‑шаги”)

### 1) Обновление документации перед REFLECT

После того как код написан (и пройдены гейты/проверки) и **перед включением режима REFLECT**:

- обновить **финальную документацию** в `Docs/` там, где изменения затрагивают:
  - архитектуру/границы слоёв
  - флоу игры/каскада и тайминги
  - перфоманс/профилирование/регресс‑правила
  - тестирование/детерминизм/тулы
  - деплой/preview

Цель: чтобы REFLECT фиксировал уже актуальное “как есть”, а не устаревшее.

### 2) “Куда класть код” — обязательная сверка на PLAN/BUILD

На этапах **PLAN** и **BUILD** перед тем как планировать/делать изменения:

- сверяться с `Docs/architecture.md` (раздел “куда класть код” + правила зависимостей)
- при спорных случаях сверяться с `memory-bank/architecture-map.md` (рабочая карта слоёв)

Цель: минимизировать архитектурные нарушения и не создавать “серые зоны” без явного решения.

## Паттерны состояния
- UI использует контроллер‑хук `useBalatroInfernoController()` как “тонкий контроллер”:
  - держит локальное UI‑состояние (фазы, анимации, shake и т.п.)
  - вызывает `application` use‑cases для чистых переходов модели
- Основные фазы игры: `gameState: 'idle' | 'dealing' | 'suspense' | 'result'`.

## Генерация данных
- `domain/deck/createDeck(rng)` создаёт колоду 52 карты + 1 джокер, иногда добавляет ещё джокеры по редкому random-roll (“chaos mode”).
- Случайность инвертирована через порт `domain/ports/rng.ts`, прод‑реализация: `infrastructure/rng/nativeRng`.

## Оценка комбинаций
- `getBestHand(cards)`:
  - без джокеров — `evaluateStandard`
  - с 1–2 джокерами — брутфорс перебор подстановок (до 2704 комбинаций), выбирается лучший `score`
  - отдельные быстрые ветки для 3/4/5 джокеров

## UI/стили
- Tailwind utility-классы в JSX + кастомные анимации/эффекты в `src/balatroInferno.css`.
- Экран декомпозирован:
  - `src/ui/screens/balatro-inferno/BalatroInferno.jsx` (композиция)
  - `src/ui/screens/balatro-inferno/components/*` (визуальные компоненты)
- Responsive‑паттерн: `grid`/`clamp(...)` для предсказуемого поведения при ресайзе (в т.ч. маленькие экраны).

## Дебаг/чест-кнопки
- Внизу UI есть скрытые/полупрозрачные кнопки `3J/4J/5J`, вызывающие `forceHand()` для теста спец-комбинаций.
