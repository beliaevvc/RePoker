# Мастер‑план рефакторинга RePoker (Clean Architecture, бесшовно)

## Цели и ограничения
- **Цель**: привести проект к максимально “чистой” слоистой архитектуре (Clean Architecture) в рамках фронтенда:
  - `domain` (бизнес‑правила/модели/чистые функции)
  - `application` (use-cases / сценарии, orchestration)
  - `infrastructure` (порты/адаптеры: RNG, таймеры, storage, внешние libs)
  - `ui` (React-компоненты, state orchestration, визуал)
- **Ограничение**: **поведение 1:1** (включая “chaos” вероятность доп. джокеров и debug-кнопки `3J/4J/5J`).
- **Бесшовность**: после каждого этапа проект **собирается и работает**.
- **Документация/комментарии**:
  - в каждом файле — “шапка” на русском (назначение, слой, инварианты, гейты этапа)
  - **JSDoc на русском** над каждой функцией/экспортом (для мелких UI‑рендеров — короткий)
- **Context7**: перед любыми добавлениями/настройками библиотек сверяемся с актуальной докой (Vite/Vitest/React/Tailwind и т.п.).

## Рекомендации по технике (выборы “как лучше”)
- **TypeScript**: да, но **поэтапно**:
  - сначала `domain` и `application` (мало React/JSX, быстро даёт пользу)
  - затем `infrastructure`
  - затем `ui` по желанию/готовности
- **DI/порты‑адаптеры**: без DI‑контейнера.
  - Используем **явную передачу зависимостей** (dependency injection через параметры/фабрики).
  - Пример: `createGameService({ rng, clock })` возвращает функции use‑case, UI вызывает сервис.
- **Тесты**: рекомендую **Vitest** (Vite-native). Минимум unit-тесты на domain.
  - Конфиг Vitest можно держать в `vite.config.*` через поле `test` + `/// <reference types="vitest/config" />` (по Context7/Vitest docs).
- **Гейты этапов** (минимальный набор):
  - `npm run lint`
  - `npm run build`
  - ручная проверка сценариев (см. чеклист “Smoke” ниже)
  - (с этапа тестов) `npm run test`

## Smoke‑чеклист (ручная проверка после каждого этапа)
- Приложение открывается, нет ошибок в консоли.
- `PLAY` раздаёт 5 карт по анимации, появляется результат.
- Баланс уменьшается на ставку и увеличивается на выигрыш (если выигрыш).
- Стрик растёт на win и сбрасывается на lose.
- `+/-` меняют ставку с теми же ограничениями.
- Debug `3J/4J/5J` работает как раньше.
- “Chaos” поведение не трогаем (вероятности и условия остаются).

## Структура папок (целевое состояние)
```
src/
  app/                      # композиция приложения (wire-up)
    composition/            # сборка зависимостей, фабрики
    main.tsx                # точка входа (после миграции)
  domain/
    cards/                  # модели карт/колоды
    hand-evaluator/         # оценка комбинаций
    game/                   # доменные правила (если выделим)
  application/
    usecases/               # сценарии (deal, adjustBet, forceHand, etc.)
    services/               # orchestration
  infrastructure/
    rng/                    # RNG port + adapter
    clock/                  # таймеры (setTimeout) port + adapter
    storage/                # (опционально) localStorage port + adapter
  ui/
    screens/
      balatro-inferno/
        BalatroInferno.tsx
        components/
        styles.css          # (опционально) локализовать стили, либо оставить общий
```

## Этапы (6–7 этапов, каждый с подэтапами)

### Этап 1 — Базовая стабилизация и “контроль поведения”
**Цель**: зафиксировать текущее поведение так, чтобы мы могли безопасно двигать код.

Подэтапы:
- Добавить “developer notes” в `memory-bank/refactor-plan.md` (этот файл) и ссылку в `tasks.md`.
- (Опционально) добавить скрипт `test` в `package.json` (пока без тестов).
- В `src/BalatroInferno.jsx` добавить русские шапки/комментарии (минимально) — **без изменения логики**.

Гейт:
- `npm run lint` проходит
- `npm run build` проходит
- smoke‑чеклист проходит

Риски:
- Очень большой файл `BalatroInferno.jsx` — комментарии могут “шуметь”. Держим краткими, но структурными.

### Этап 2 — Введение TypeScript (минимальный каркас) + настройка тестов (Vitest)
**Цель**: подготовить проект к поэтапной миграции без “большого взрыва”.

Подэтапы:
- Добавить TypeScript: `typescript`, `tsconfig.json`, `vite-env.d.ts` при необходимости.
- Настроить Vite под TS (по Context7/Vite): `isolatedModules: true`, (желательно) `moduleResolution: "bundler"`.
- Переименовать только точку входа/конфиг при необходимости (можно оставить JS в UI и начать с domain).
- Добавить Vitest: `vitest` + конфиг:
  - либо `vite.config.ts` и `test: { ... }` + `/// <reference types="vitest/config" />`
  - либо отдельный `vitest.config.ts` (если нужно отделить).

Гейт:
- `npm run build` проходит
- `npm run lint` проходит
- `npm run test` проходит (пусть даже 0 тестов, но раннер подключён)
- smoke‑чеклист

### Этап 3 — Вынос `domain`: карты/колода/оценка комбинаций (1:1)
**Цель**: сделать домен чистым и тестируемым.

Подэтапы:
- Создать `src/domain/cards/*`:
  - типы `Suit`, `Rank`, `Card`
  - константы `SUITS`, `RANKS`, `RANK_NAMES`
- Создать `src/domain/hand-evaluator/*`:
  - `HAND_MULTIPLIERS`, `HAND_TIERS`
  - `getBestHand(cards)` + вспомогательные функции
- Перенести `createDeck()` в `domain` **без изменения вероятностей**.
- Везде добавить шапки файлов + JSDoc к функциям.
- Написать unit‑тесты Vitest на:
  - базовые комбинации без джокера
  - спец‑кейсы `3/4/5 Jokers`
  - 1–2 джокера (минимум несколько фиксированных наборов)

Гейт:
- `npm run test` зелёный
- smoke‑чеклист

Стратегия отката:
- Если что-то ломается — UI временно импортирует старую реализацию из `BalatroInferno.jsx` до починки тестов.

### Этап 4 — `application`: use-cases и сценарии игры
**Цель**: отделить “что делаем” от “как показываем”.

Подэтапы:
- Создать use-cases:
  - `dealHand` (управляет стадиями, но без таймеров)
  - `applyBet`, `adjustBet`, `resolveResult`
  - `forceHand(jokerCount)` для debug (1:1)
- Вынести “модель состояния игры”:
  - `GameState` (idle/dealing/suspense/result)
  - структура `GameModel` (balance, bet, streak, hand, deck, dealIndex, result)
- Подготовить интерфейсы (порты), которые понадобятся инфраструктуре:
  - `Rng` (randomFloat / shuffle)
  - `Clock` (timeout/sleep)

Гейт:
- `npm run test` (добавляем тесты на use‑cases минимум на чистые функции)
- smoke‑чеклист

### Этап 5 — `infrastructure`: адаптеры RNG/Clock (+ подготовка к storage/particles)
**Цель**: убрать `Math.random()` и `setTimeout()` из домена/usecases, но **сохранить поведение**.

Подэтапы:
- `src/infrastructure/rng`:
  - `Rng` интерфейс
  - `nativeRng` адаптер (`Math.random`) — прод
  - `seededRng` адаптер — **только для тестов**
- `src/infrastructure/clock`:
  - `Clock` интерфейс
  - `browserClock` адаптер (`setTimeout/clearTimeout`)
  - `fakeClock` для тестов (опционально)
- Обновить use-cases, чтобы зависимости передавались явно (без контейнера).

Гейт:
- тесты зелёные
- smoke‑чеклист

### Этап 6 — `ui`: декомпозиция экрана, компонентов и стилей
**Цель**: сделать UI тонким и поддерживаемым.

Подэтапы:
- Разбить `BalatroInferno` на подкомпоненты:
  - `Card`, `PixelSuit`, `ElectricPlasmaOrbs`, “HUD” (balance/bet), “Controls”
- Вынести тяжёлые куски в `src/ui/screens/balatro-inferno/components/*`.
- Выделить `useBalatroInfernoController()` (hook), который связывает UI с application layer.
- Стили:
  - либо оставить `src/balatroInferno.css`, но структурировать и задокументировать
  - либо перенести в `src/ui/screens/.../styles.css` (с сохранением эффекта 1:1)
- Везде добавить русские шапки + JSDoc.

Гейт:
- `npm run build` + smoke‑чеклист (это этап визуальный, тут ручная проверка особенно важна)

### Этап 7 — Финализация: best practices, чистка, документация
**Цель**: закрепить результат и сделать дальнейшую разработку простой.

Подэтапы:
- Добить “хвосты” миграции на TS (если решили довести UI тоже).
- Выровнять правила ESLint под TS (если включаем).
- Обновить `memory-bank/systemPatterns.md` (новая структура слоёв).
- Обновить `memory-bank/techContext.md` (TS + Vitest).
- Добавить `README` проекта (если нужно) с кратким описанием слоёв.

Гейт:
- `npm run lint`, `npm run build`, `npm run test`
- smoke‑чеклист

## Шаблоны комментариев (обязательные)

### Шапка файла
```js
/**
 * Файл: <путь>
 * Слой: domain|application|infrastructure|ui
 * Назначение: <1-2 предложения>
 * Инварианты: <что нельзя ломать>
 * Гейт этапа: <что проверить после правок>
 */
```

### JSDoc функции
```js
/**
 * Кратко: что делает функция.
 *
 * @param {...} ...
 * @returns ...
 * @remarks Важные детали/ограничения/побочные эффекты.
 */
```


