# Прогресс

## Статус
- Сделано (UI/CASCADE): добавлена **история выигрышей каскада** — кнопка `WINS (N)` под `CASCADE MULT` открывает модалку со скролл-списком всех win-шагов (STEP, рука, сумма, множитель, 5 мини‑карт). Кнопка активна **только после завершения каскада** и слегка “шимерит”.
- Сделано (UI/CASCADE): под `CASCADE MULT` добавлен **накопительный** индикатор `WIN {total}` — появляется **только после первого выигрыша** и на каждом win‑каскаде **анимировано прибавляется** на сумму шага; скрывается при переходе в финальный баннер `TOTAL WIN`.
- Апдейт по фидбэку: `WIN` теперь расположен **под мультипликаторами**, **остаётся видимым на экране результата** вместе с финальным баннером, и **сбрасывается перед новой сдачей**.
- Технически: `cascadeRunningTotalWin` теперь обновляется **в момент reveal win‑баннера шага** (для синхронной анимации), без двойного инкремента; добавлены CSS `animate-cascade-win-pop` + `cascade-win-glow`.
- Гейты: `npm run lint` — ✅, `npm test` — ✅ (24/24), `npm run build` — ✅ (прогон вне sandbox из-за `EPERM` на чтении `node_modules` в sandbox).
- Архив: `memory-bank/archive/archive-2025-12-23-cascade-running-win.md`
- Архив: `memory-bank/archive/archive-2025-12-23-cascade-win-history.md`
- Завершено: баланс — снижена выплата за **Pair** с 0.3x на 0.2x.
- Сделано: обновлён доменный источник истины `HAND_MULTIPLIERS.Pair` (0.3 → 0.2).
- Сделано: обновлены unit-тесты (domain/application), которые ожидали 0.3x и расчёты на базе 0.3×bet.
- Гейты: `npm test` — ✅ (24/24, вне sandbox из-за `EPERM kill`), `npm run lint` — ✅, `npm run build` — ✅.
- Архив: `memory-bank/archive/archive-2025-12-23-pair-0.2x.md`
- Дальше: `/van`.
- В работе: UI — каскадные множители должны отображаться “заранее” после раздачи (до подсветки/баннера), чтобы игрок видел потенциал следующего шага.
- Сделано: `CascadeMultiplierIndicator` в CASCADE теперь рендерится в `suspense` (STEP 1 / x1) и в `cascading` показывает:
  - во время win-баннера — текущий шаг (STEP N / xN применённый),
  - между шагами — следующий потенциальный (STEP N+1 / x...).
- Сделано: preview-множитель считается через `getCascadeMultiplierForWinStep` (без дублирования таблицы).
- Дальше: прогнать гейты (test/lint/build) и быстро руками проверить: после раздачи виден STEP1/x1, после 1-го win (баннер скрылся) виден STEP2/x2.
- Гейты: `npm run test` — ✅ (24/24), `npm run lint` — ✅, `npm run build` — ✅ (прогон вне sandbox, т.к. в sandbox `vitest` падал `EPERM kill`).
- Апдейт по UX: плашка `CascadeMultiplierIndicator` в режиме CASCADE теперь **висит всегда** (не пропадает), а вне активного каскада **сбрасывается** на `STEP 1 / x1`.
- Гейты после апдейта: `npm run test` — ✅ (24/24), `npm run lint` — ✅, `npm run build` — ✅ (вне sandbox).
- Апдейт по UX (ещё точнее): **до старта новой раздачи** (idle/result) плашка в CASCADE находится в режиме **OFF** (ничего не горит, `x—`), а **с начала dealing** сразу “зажигается” `STEP 1 / x1`.
- Апдейт по UX (STEP): в режиме OFF теперь показываем **STEP 0** (пока шага ещё нет).
- Уточнение: OFF отменён — в CASCADE **x1 горит всегда** (даже в `idle/result` показываем `STEP 1 / x1`).
- Архив: `memory-bank/archive/archive-2025-12-22-cascade-mult-preview-x1.md`
- В работе: UI — “MAX WIN 150.000x” в шапке перестал быть золотым с переливом.
- Найдено: в `BalatroInferno.jsx` используется класс `text-gold-shimmer`, но его определения в CSS не было, поэтому стиль не применялся.
- Сделано: добавлен `.text-gold-shimmer` + анимация перелива `@keyframes gold-shimmer` в `src/balatroInferno.css` (с `prefers-reduced-motion` fallback).
- Гейты: `npm run build` — ✅.
- Архив: `memory-bank/archive/archive-2025-12-21-maxwin-gold-shimmer.md`
- Дальше: `/van`.
- В работе: UI — плашка CHIPS переполнялась на больших суммах (текст “вылазал” за карточку), перенос строки запрещён.
- Сделано: добавлен общий helper форматирования денег (full/compact/adaptive) и подключён в `BalatroInferno` + `DevToolsDrawer`.
- Сделано: CHIPS теперь показывает **adaptive** значение (full пока помещается, иначе compact), а полное значение доступно через `title` (tooltip).
- Гейты: `npm run lint` — ✅ (в sandbox падал с EPERM на чтении `node_modules`, прогнан вне sandbox).
- Гейты: `npm test` — ✅ (24/24).
- Гейты: `npm run build` — ✅.
- Дальше: обновить чеклист задачи и перейти в `/reflect`.
- В работе: UI — на full desktop надпись “MAX WIN 150,000X” (`MaxWinPoster`) пересекалась с плашками CHIPS/ANTE.
- Сделано: `MaxWinPoster` переведён на более безопасный layout внутри центральной колонки (`inset-x-0`, `text-center`, `px-1`, `leading-none`) и ограничен рост типографики на `2xl` (уменьшен max в `clamp()`), чтобы на 1920+ не “раздувалось” и не подрезалось соседними плашками.
- Твик: “150,000X” заменено на “150.000x”, `x` сделан в 2 раза меньше (через `0.5em`), а вторая строка слегка опущена вниз (положительный `mt clamp`) для “воздуха”.
- Гейты: `npm run test` — ✅ (24/24), `npm run lint` — ✅, `npm run build` — ✅ (прогон вне sandbox из-за `EPERM kill` в sandbox).
- В работе: UI — увеличить высоту нижнего блока кнопок (TURBO/PLAY/AUTO/+/-), чтобы кнопки выглядели “толще” на ~50–60%.
- Сделано: нижнему grid-контейнеру добавлен `min-height` (через `clamp`) + увеличена “толщина” press-эффекта (border-b/translate) для пропорционального ощущения.
- Дальше: быстро проверить на mobile/desktop и прогнать гейты (lint/test/build).
- Гейты (вне sandbox из-за EPERM в sandbox): `npm run lint` — ✅, `npm run test` — ✅ (24/24), `npm run build` — ✅.
- Твик: высота блока нижних кнопок уменьшена ещё на ~10% (через `min-h clamp`), сохранив пропорции всех кнопок.
- В работе: Dev Mode / Dev Tools drawer (кнопка DEV рядом с режимом, перенос JP, action log, deck watch).
- Сделано (Dev Tools gating): добавлен gating Dev Tools — dev-сборка всегда разрешена, в проде включается только через `localStorage` (`repoker.devTools=1`) или query `?dev=1`/`?devtools=1`. Hotkey `D` теперь работает только при разрешённых Dev Tools.
- Сделано (Dev Tools UI): добавлен компонент `DevToolsDrawer` (drawer слева на desktop / bottom-sheet на мобилке), который остаётся видимым во время каскада.
- Сделано (перенос кнопок): убраны `JP`, `1J`, `2J` из основного UI рядом с PLAY; `JP SIM` доступен в Dev Tools.
- Сделано (action log): добавлен in-memory лог событий (cap 400) + кнопки Pause/Clear/Copy.
- Сделано (deck watch): в Dev Tools отображаются `deckRemaining`, `dealIndex`, `deckLen` и ключевые поля состояния (`mode`, `gameState`, `cascadeStepIndex`, jackpot flags).
- Гейты (Dev Tools): `npm run lint` — ✅, `npm run test` — ✅ (24/24), `npm run build` — ✅.
- Фикс: DEV-кнопка теперь показывается **в dev-сборке даже на узком (mobile) viewport**; в проде поведение без изменений (на мобилке скрыто без explicit enable).
- Dev Tools UX: убран backdrop (нет затемнения и закрытия по клику вне панели), лог/стата переведены в человекочитаемый **русский** формат, кнопки лога теперь не “вылазят”.
- В работе: Turbo-кнопка (ускорение темповых анимаций/таймингов без ускорения декоративных shake/ореолов).
- Сделано (Turbo): добавлен `turboEnabled` в `useBalatroInfernoController`, ускорены JS-тайминги раздачи/suspense/каскада через масштабирование задержек.
- Сделано (Turbo UI): добавлена кнопка `TURBO` в верхней панели `BalatroInferno`, toggle ON/OFF, disabled во время `isBusy`, без сохранения в `localStorage`.
- Сделано (Turbo CSS): добавлен класс `.repoker-turbo` с `--repoker-time-factor: 0.5`; ускорены `animate-cascade-vanish/appear/refill-flash` и `animate-cascade-mult-pop`; ускорены `transitionDelay/Duration` карт через CSS‑переменную.
- QA: `npm run test` — ✅ (24/24). `npm run lint` — ✅. `npm run build` — ✅.
- Примечание: test/lint в sandbox падали с `EPERM` (чтение/kill воркеров), поэтому прогон делался вне sandbox.
- Дальше: `/reflect`.
- Сделано: UI — `JACKPOT SIM (QA)` перенесена вправо от кнопки PLAY и сделана еле заметной.
- Гейты: `npm run lint`, `npm run build` — пройдены.
- В работе: множитель каскада (1×→2×→3×→5×) + UI-индикатор, замена streak в CASCADE.
- Сделано (механика): добавлен `getCascadeMultiplierForWinStep` + unit-тесты; `applyCascadeStepUseCase` принимает `winStepNumber` и считает `winAmount = baseWinAmount * cascadeMultiplier`, джекпот не множится.
- Сделано (интеграция): `useBalatroInfernoController` передаёт `winStepNumber = cascadeStepIndex+1`, копит totalWin с учётом множителя и **не меняет streak** в CASCADE; добавлены состояния `cascadeWinStepNumber/cascadeMultiplier`.
- Сделано (UI): добавлен `CascadeMultiplierIndicator` (в CASCADE вместо `ElectricPlasmaOrbs`) + строка `CASCADE MULT xN` в step win-баннере.
- Сделано (UI): в финальный баннер `TOTAL WIN` добавлена строка `MAX MULT xN` (максимальный достигнутый множитель по win-шагам каскада).
- Гейты (после множителя каскада): `npm run test`, `npm run lint`, `npm run build` — пройдены.
- Сделано: переделаны ставки **Ante** — введён фиксированный список (0.20…100), дефолт **1.00**, кнопки `+/-` переключают по списку, суммы в UI отображаются с 2 знаками после запятой.
- Гейты (после Ante): `npm run test`, `npm run lint`, `npm run build` — пройдены.
- В работе: обновление выплат за комбинации.
- Сделано: обновлена доменная таблица выплат (`HAND_MULTIPLIERS`) под новую спецификацию (Pair=0.3x, Two Pair=1x, ...), удалены `3/4/5 Jokers` и `Five of a Kind`.
- Сделано: `getBestHand` больше не возвращает удалённые комбинации; добавлен guard на `jokerCount > 2`.
- Сделано: debug форс руки теперь поддерживает только 1–2 джокера (UI + `forceHandUseCase`).
- Сделано: добавлена нормализация денег в application use-cases (чтобы не было `3.5999999999999996` при 0.3×bet).
- Сделано: UI-константы/эффекты очищены от упоминаний `3/4/5 Jokers` и tier=7.
- Гейты пройдены: `npm run test`, `npm run lint`, `npm run build` — зелёные.
- Завершено: режим **каскада** + переключение режимов (normal/cascade) + визуальный таймлайн, гейты зелёные.
- Завершено: каскад **без автопополнения колоды** — при нехватке добора недостающие позиции становятся `null`, каскад завершается после шага.
- Завершено: добавлен **джекпот 150 000× bet**, если после win-шага каскада стол полностью пуст и колода пуста (начисляется сверху).
- Завершено: добавлена QA-фича **JACKPOT SIM** (кнопка в CASCADE), запускающая один из 5 сценариев, которые гарантированно приводят к джекпоту за несколько шагов.
- Сделано: `JACKPOT SIM (QA)` больше не занимает отдельную широкую строку — перенесена в правую колонку контролов рядом с PLAY как маленькая кнопка “JP” с низкой opacity (видна на hover).
- Завершено: UI-фикс — убран белый overlay `animate-ping ... bg-white` из баннера выигрыша (BalatroInferno).
- Завершено: финальный баннер каскада — показ “CASCADES xN” (кол-во шагов) второй строкой под TOTAL WIN.
- Завершено: UI-спейсинг — добавлен нижний отступ под панелью MODE, чтобы она не “прилипала” к блоку ANTE.
- Гейты: `npm run lint`, `npm run test`, `npm run build` — пройдены.
- Завершено: багфикс — при 1 джокере и комбинации **Pair** выбирается пара со **старшей** картой (добавлен тай-брейк внутри категории при брутфорсе джокера).
- Гейты (после фикса джокера): `npm run test`, `npm run lint`, `npm run build` — пройдены.
- Завершено: основная колода обновлена до **52 + 2 джокера = 54** (единый источник истины через `createBaseDeck`).
- Завершено: **JACKPOT SIM** переведён на использование основной колоды (убран отдельный debug-состав на 57/5 джокеров).
- Гейты (после обновления колоды): `npm run test`, `npm run lint`, `npm run build` — пройдены.
- Завершено: UI — **Paytable Modal** (таблица выплат) с миниатюрами карт и изменением ставки.
- Архив: `memory-bank/archive/archive-2025-12-23-paytable.md`
- Завершено: UI — Paytable: добавлен блок **DECK CLEAR** (без слова “jackpot”) с условием полной очистки 54‑картной колоды за 1 каскад и выплатой **150.000x**; унифицирован формат **150.000x** в MAX WIN оверлеях.
- Гейты: `npm run build` — ✅
- Архив: `memory-bank/archive/archive-2025-12-23-deck-clear-paytable.md`
- Дальше: `/van` для следующей задачи.
