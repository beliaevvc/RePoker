# Product Context — RePoker

## Пользовательский сценарий (текущий)

### Базовый сценарий игры
- Игрок выбирает размер ставки (кнопки `+`/`-`).
- Нажимает **PLAY** → раздаётся 5 карт (анимация "dealing").
- После короткой паузы вычисляется лучшая комбинация и обрабатывается результат в зависимости от режима игры.

### Режим NORMAL
- ⚠️ **Отключен** (флаг `NORMAL_MODE_ENABLED = false`). Возможно будет удалён в будущем.
- Одна оценка руки → один payout.
- Если выигрыш: показывается название комбинации, начисляются "chips" (`bet * multiplier`), растёт streak.
- Если проигрыш: показывается "HIGH CARD / NO CHIPS", streak сбрасывается.

### Режим CASCADE (основной режим)
- Серия каскадных шагов: на каждом шаге определяется лучшая комбинация.
- Если на шаге есть выигрыш (`multiplier > 0`):
  - Показывается баннер выигрыша с названием комбинации.
  - Выигрышные карты (из `winningIndices`) исчезают с анимацией "vanish".
  - На освободившиеся позиции добираются новые карты из колоды (анимация "appear").
  - Каскад продолжается со следующего шага.
- Если выигрыша нет (High Card) → каскад заканчивается.
- Выигрыш суммируется по всем шагам и начисляется **одним платежом** в конце каскада.
- Streak: **не используется** в режиме CASCADE (отключён, вместо него применяются каскадные множители).
- Если колода закончилась во время каскада → создаётся новая колода и каскад продолжается.

### Автоплей (AUTO)
- Игрок нажимает кнопку **AUTO** → открывается модалка выбора количества спинов (10/25/50/100/∞).
- После выбора и нажатия **START** игра автоматически выполняет указанное количество спинов.
- Каждый спин запускается автоматически после завершения предыдущего (когда экран в состоянии `idle` или `result`).
- Автоплей останавливается при:
  - Завершении всех спинов (счётчик на кнопке PLAY показывает оставшееся количество).
  - Нехватке денег (`balance < bet`).
  - Ручной остановке (нажатие **STOP** в модалке или повторное нажатие **AUTO**).
- Работает одинаково в режимах NORMAL и CASCADE.

### TURBO режим
- Кнопка **TURBO** ускоряет все анимации игры в **2 раза** (множитель времени `0.5`).
- Влияет на:
  - Скорость раздачи карт (таймеры между картами).
  - Таймлайн каскада (все анимации vanish/appear/refill-flash).
- Можно включать/выключать в любой момент (переключатель с визуальной индикацией).

## Основные игровые сущности

### Deck/Hand
- Колода создаётся заново на каждую раздачу через use-case `startDealUseCase` (`src/application/game/usecases/startDeal.ts`).
- Базовая колода: 52 карты (4 масти × 13 рангов) + 1 джокер.
- Крайне редко добавляются дополнительные джокеры ("chaos mode").
- Hand (рука): 5 карт на столе, которые оцениваются на каждом шаге каскада.

### Balance
- Стартовый баланс: **100 chips**.
- Ставка списывается при начале раздачи (`startDealUseCase`).
- Выигрыш начисляется:
  - В режиме NORMAL: `bet * multiplier` сразу после оценки.
  - В режиме CASCADE: `totalWin` (сумма всех шагов) одним платежом в конце каскада.

### Bet
- Ограничена минимумом **0.2** (минимальное значение из списка `ANTE_VALUES`) и максимумом **100** (максимальное значение из списка `ANTE_VALUES`).
- Изменяется через use-case `adjustBetUseCase` (`src/application/game/usecases/adjustBet.ts`).
- Доступные значения ставок: 0.2, 0.4, 0.6, 0.8, 1.0, 1.2, 1.4, 1.6, 1.8, 2.0, 3.0, 5.0, 10, 20, 30, 50, 100 (определены в `src/application/game/constants/ante.ts`).

### Streak
- Отображается "орбами" (`ElectricPlasmaOrbs`) и влияет на визуальные эффекты.
- В режиме NORMAL: растёт при выигрыше, сбрасывается при проигрыше (⚠️ режим NORMAL отключен и возможно будет удалён).
- В режиме CASCADE: **не используется** и не меняется (streak отключён в каскаде, вместо него применяются каскадные множители).

### Каскадные множители
- Применяются к выплатам за комбинации в режиме CASCADE.
- Правила (реализовано в `src/application/game/cascadeMultiplier.ts`):
  - win-step 1: **1×**
  - win-step 2: **2×**
  - win-step 3: **3×**
  - win-step 4+: **5×**
- Множитель применяется **только к выплате за комбинацию** (`bet * handMultiplier * cascadeMultiplier`), **не** применяется к jackpot.
- Если выигрыша нет (High Card) → каскад заканчивается, множитель не применяется.

## Комбинации и множители

- Оценка комбинаций реализована в `getBestHand()` (`src/domain/hand-evaluator/getBestHand.ts`).
- Поддерживаются:
  - Спец-комбинации джокеров: `3 Jokers`, `4 Jokers`, `5 Jokers` (для debug-режима).
  - Стандартные покерные комбинации: Royal Flush, Straight Flush, Four of a Kind, Full House, Flush, Straight, Three of a Kind, Two Pair, Pair, High Card.
- Таблицы `HAND_TIERS` и `HAND_MULTIPLIERS` находятся в `src/domain/hand-evaluator/constants.ts`.
- Множители выплат (на ставку игрока):
  - Pair: **0.2×**
  - Two Pair: **1×**
  - Three of a Kind: **5×**
  - Straight: **10×**
  - Flush: **20×**
  - Full House: **50×**
  - Four of a Kind: **100×**
  - Straight Flush: **200×**
  - Royal Flush: **1000×**
  - High Card: **0×** (нет выплаты)

## Режимы игры

### NORMAL vs CASCADE
- **NORMAL**: классический режим — одна оценка руки, один payout, streak растёт/сбрасывается. ⚠️ **Отключен** (флаг `NORMAL_MODE_ENABLED = false`) и возможно будет удалён в будущем.
- **CASCADE**: каскадный режим — серия шагов с удалением выигрышных карт и добором новых, выигрыш суммируется и начисляется в конце, каскадные множители применяются к выплатам. **Является единственным активным режимом**.
- Переключение режимов: через UI (в текущей версии переключение скрыто, так как NORMAL отключен).
- Выбор режима сохраняется в `localStorage` между перезапусками.

## Автоплей

- **Кнопка AUTO**: открывает модалку выбора количества спинов.
- **Варианты**: 10, 25, 50, 100 спинов или бесконечно (∞).
- **Механизм**: оркестратор на основе `useEffect` в контроллере (`useBalatroInfernoController.js`).
- **Условия запуска**: баланс достаточен (`balance >= bet`), экран не занят (`!isBusy`).
- **Условия остановки**:
  - Завершение всех спинов (счётчик `autoRemaining` достиг 0).
  - Нехватка денег (`balance < bet`).
  - Ручная остановка (кнопка STOP в модалке).
- **Визуальная индикация**: счётчик оставшихся спинов отображается на кнопке PLAY.

## TURBO режим

- **Кнопка TURBO**: переключатель ускорения анимаций.
- **Множитель времени**: `0.5` (в 2 раза быстрее).
- **Влияние на таймлайн**:
  - Раздача карт: таймеры между картами сокращены (40ms → 20ms).
  - Каскадные анимации: все таймеры vanish/appear/refill-flash ускорены через `scheduler` (`src/ui/screens/balatro-inferno/scheduler.js`).
- **Визуальная индикация**: кнопка подсвечивается жёлтым при включении.

## UX/визуальный стиль

- **Пиксельный стиль**: ретро-аркада с пиксельной графикой.
- **CRT-оверлей**: эффект старинного монитора (scanlines, RGB-смещение, затемнение краёв) — реализовано через CSS класс `.crt-overlay` в `src/balatroInferno.css`.
- **Анимации при выигрыше**: огонь, "электрика", тряска экрана.
- **Анимации каскада**:
  - `cascade-vanish`: исчезновение выигрышных карт.
  - `cascade-appear`: появление новых карт на освободившихся позициях (по одной с задержкой).
  - `cascade-refill-flash`: короткий highlight после завершения добора карт.
- **Шрифт**: **Press Start 2P** (Google Fonts).
  - Загружается через `<link rel="stylesheet">` в `index.html` (ранняя загрузка для LCP).
  - Добавлены `preconnect` на `fonts.googleapis.com` и `fonts.gstatic.com`.
  - Применяется через CSS класс `.font-press-start` в `src/balatroInferno.css`.
- **Стили**: Tailwind CSS v4 + кастомный CSS (`src/balatroInferno.css`).
