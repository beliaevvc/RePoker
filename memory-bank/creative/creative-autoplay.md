# Creative — AutoPlay (AUTO): модалка, счётчик, логика

## Контекст
Нужно окно автоигры по кнопке `AUTO`:
- пресеты: **10 / 25 / 50 / 100 / 500 / 1000 / ∞**
- **∞** — отдельная кнопка “побольше и красивее”
- кнопка **START превращается в STOP** (toggle)
- после старта запускается автоигра на выбранное кол-во
- на `PLAY` появляется **обратный счётчик оставшихся**
- если **CHIPS < ANTE** или попытка стартовать при **busy** → **останавливаем** авто

## 1) UI/UX окна AUTO (куда и как показываем)

### Вариант A — модалка (desktop: центр, mobile: bottom-sheet)
- **Как выглядит**: `fixed inset-0` + лёгкий backdrop (не “чёрная стена”, а `bg-black/40`), поверх — панель в стиле win‑баннера (толстая рамка, тень, лёгкий наклон/скос).
- **Плюсы**: максимально понятный “окно‑паттерн”; на мобилке удобно (не перекрывает пальцем центр); проще верстка пресетов.
- **Минусы**: перекрывает игру на момент выбора (но быстро закрывается).

### Вариант B — поповер над кнопкой AUTO (без backdrop)
- **Как выглядит**: небольшая панель “прилипает” к кнопке `AUTO`.
- **Плюсы**: минимально вмешивается в экран; очень “arcade”.
- **Минусы**: на мобилке риск переполнения по высоте/ширине; сложнее сделать “большую ∞ кнопку” красиво.

### Вариант C — постоянная панель рядом с контролами
- **Как выглядит**: блок выбора всегда виден внизу.
- **Плюсы**: ноль модалок.
- **Минусы**: перегружает основной экран; съедает место у карт/эффектов.

**Решение**: **Вариант A** (модалка + адаптация как sheet на mobile).

### Детали модалки (рекомендация)
- Заголовок: **AUTO PLAY** (малый, uppercase, tracking).
- Сетка пресетов: 2 ряда × 3 кнопки (10/25/50 и 100/500/1000).
- Отдельная кнопка **∞**:
  - большая, на всю ширину (или справа “плашка”), с `font-press-start` и крупным `∞`
  - визуально “особая”: градиент/неон‑обводка/легкий glow
- Primary‑кнопка:
  - когда авто не запущено: **START**
  - когда запущено: **STOP**
- Доступность:
  - **START disabled**, если `isBusy` или `balance < bet` (и небольшая подсказка текстом под кнопками)

## 2) Счётчик автоигры на кнопке PLAY

### Вариант A — badge внутри PLAY (верхний‑правый угол)
- **Как выглядит**: маленький “пилюльный” бейдж `AUTO 25` или просто `25`, закреплён `absolute top-2 right-2`.
- **Для ∞**: показываем `∞` (или `AUTO ∞`).
- **Плюсы**: всегда видно, не ломает композицию текста `PLAY`; выглядит как “HUD”.
- **Минусы**: нужно аккуратно подобрать размер, чтобы не спорило с иконкой.

### Вариант B — второй ряд текста в кнопке PLAY
- **Как выглядит**: `PLAY` + снизу `AUTO: 25`.
- **Плюсы**: очень читаемо.
- **Минусы**: меняет высоту/типографику кнопки; может “прыгать” при .../PLAY.

### Вариант C — счётчик на кнопке AUTO
- **Плюсы**: логически “про авто”.
- **Минусы**: пользователь смотрит на центр (PLAY), и счётчик теряется.

**Решение**: **Вариант A** (badge в углу PLAY).

## 3) Логика авто-цикла (когда делать следующий спин)

### Вариант A — эффект‑оркестратор (рекоменд.)
- Держим состояние авто в `useBalatroInfernoController`:
  - `autoModalOpen`
  - `autoSelectedCount` (последний выбор, для UX)
  - `autoRunning` (bool)
  - `autoRemaining` (number)
  - `autoInfinite` (bool)
- `useEffect` следит за `(autoRunning, autoRemaining, autoInfinite, gameState, balance, bet)`:
  - когда `gameState` становится **`idle` или `result`** и `autoRunning`:
    - если `balance < bet` → `stopAuto(reason='no-money')`
    - иначе пробуем `startDeal()` (общая функция, которую используют и `handleDeal`, и автоплей)
    - если `startDeal()` не смог (busy/guard вернул null) → `stopAuto(reason='cannot-start')`
    - если старт успешен и не ∞ → `autoRemaining -= 1` (и если стало 0 → `stopAuto(reason='done')`)
- **Плюсы**: простая и предсказуемая схема; без таймерных “гонок”; легко тестировать вручную.
- **Минусы**: потребует аккуратно избежать двойного старта (решается guard’ом и/или “pendingRef”).

### Вариант B — рекурсивные таймеры
- **Минусы**: больше шансов на гонки/утечки; сложнее синхронизировать с каскадом.

### Вариант C — отдельная state‑машина автоплея
- **Минусы**: избыточно для текущего масштаба.

**Решение**: **Вариант A**.

### Ключевые UX‑правила (фиксируем)
- `AUTO` открывает окно выбора всегда, даже если авто уже запущено (чтобы можно было нажать STOP).
- Когда `autoRunning=true`, в модалке primary‑кнопка = **STOP**.
- Счётчик на `PLAY` показываем **только когда авто запущено**.
- “Stop при busy” трактуем как: **не стартуем авто, если уже идёт анимация** (`isBusy`), и **не пытаемся очередь/ожидание** — просто стоп/не старт.

## Критерии успеха (UX)
- Нажал `AUTO` → выбрал 100 → `START` → авто крутит 100 спинов, на `PLAY` виден 100→…→1.
- Нажал `AUTO` во время авто → видишь `STOP`, нажал → авто сразу остановилось, счётчик исчез.
- Если `CHIPS < ANTE` — авто не стартует (или если уже было запущено и деньги кончились — остановилось само).
- В CASCADE и NORMAL поведение одинаковое (просто авто запускает “как PLAY”).


